<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>001</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="Container">
  <h1>Relat√≥rio Financeiro</h1>

  <label for="accountSelect">Escolha a conta:</label>
<select id="accountSelect">
  <option value="">Todas as contas</option>
</select>

<br><br>

  <ul id="productList"></ul>

  <h1>2025</h1>
<table border="1" id="profitTable">
  <thead>
    <tr>
      <th>Categoria</th>
      <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
      <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>


  <script>

    /*
    async function loadProducts() {
      const res = await fetch("/api/products");
      const products = await res.json();

      const ul = document.getElementById("productList");
      products.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.product_id} - ${p.product_name}`;
        ul.appendChild(li);
      });
    }

    loadProducts();
    */

    async function loadAccounts() {
      const res = await fetch("/api/accounts");
      const accounts = await res.json();

      const select = document.getElementById("accountSelect");

      accounts.forEach(acc => {
        const option = document.createElement("option");
        option.value = acc.ccusto;
        option.textContent = acc.ccusto;
        select.appendChild(option);
      });
    }

    //let currentTopic = null

   async function loadMonthlyProfit(account = "") {
    let url = "/api/monthly-profit";
    if (account) url += `?account=${account}`;

    const res = await fetch(url);
    const topics = await res.json();

    const tbody = document.querySelector("#profitTable tbody");
    tbody.innerHTML = "";

    Object.entries(topics).forEach(([topic, data]) => {

      // topic row (WITH TOTALS)
      tbody.appendChild(createTopicRow(topic, data.totals));

      // categories
      data.categories.forEach(cat => {
        tbody.appendChild(createCategoryRow(cat));
      });
    });
  }

  function createTopicRow(topic, totals) {
    const tr = document.createElement("tr");
    tr.classList.add("topic-row");

    tr.innerHTML = `
      <td>${topic}</td>
      <td>${totals.jan}</td><td>${totals.fev}</td><td>${totals.mar}</td><td>${totals.abr}</td>
      <td>${totals.mai}</td><td>${totals.jun}</td>
      <td>${totals.jul}</td><td>${totals.ago}</td><td>${totals.set}</td>
      <td>${totals.out}</td><td>${totals.nov}</td><td>${totals.dez}</td>
    `;
    return tr;
  }

  function createCategoryRow(row) {
    const tr = document.createElement("tr");
    tr.classList.add("category-row");

    tr.innerHTML = `
      <td>${row.category_name}</td>
      <td>${row.jan}</td><td>${row.fev}</td><td>${row.mar}</td><td>${row.abr}</td>
      <td>${row.mai}</td><td>${row.jun}</td>
      <td>${row.jul}</td><td>${row.ago}</td><td>${row.set}</td>
      <td>${row.out}</td><td>${row.nov}</td><td>${row.dez}</td>
    `;
    return tr;
  }

    document.getElementById("accountSelect").addEventListener("change", e => {
      loadMonthlyProfit(e.target.value);
    });

    loadAccounts();
    loadMonthlyProfit();  

  </script>
  </div>
</body>
</html>
